import e from"cross-fetch";import{PrivateKey as t,encrypt as n,decrypt as o}from"eciesjs";import{EventEmitter2 as i}from"eventemitter2";import{validate as r,v4 as s}from"uuid";import{io as a}from"socket.io-client";function c(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const u=(t,n)=>c(void 0,void 0,void 0,(function*(){const o=n.endsWith("/")?`${n}debug`:`${n}/debug`,i=JSON.stringify(t),r=yield e(o,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:i});return yield r.text()}));var l="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},d=[],h=[],g="undefined"!=typeof Uint8Array?Uint8Array:Array,f=!1;function y(){f=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)d[t]=e[t],h[e.charCodeAt(t)]=t;h["-".charCodeAt(0)]=62,h["_".charCodeAt(0)]=63}function m(e,t,n){for(var o,i,r=[],s=t;s<n;s+=3)o=(e[s]<<16)+(e[s+1]<<8)+e[s+2],r.push(d[(i=o)>>18&63]+d[i>>12&63]+d[i>>6&63]+d[63&i]);return r.join("")}function p(e){var t;f||y();for(var n=e.length,o=n%3,i="",r=[],s=16383,a=0,c=n-o;a<c;a+=s)r.push(m(e,a,a+s>c?c:a+s));return 1===o?(t=e[n-1],i+=d[t>>2],i+=d[t<<4&63],i+="=="):2===o&&(t=(e[n-2]<<8)+e[n-1],i+=d[t>>10],i+=d[t>>4&63],i+=d[t<<2&63],i+="="),r.push(i),r.join("")}function E(e,t,n,o,i){var r,s,a=8*i-o-1,c=(1<<a)-1,u=c>>1,l=-7,d=n?i-1:0,h=n?-1:1,g=e[t+d];for(d+=h,r=g&(1<<-l)-1,g>>=-l,l+=a;l>0;r=256*r+e[t+d],d+=h,l-=8);for(s=r&(1<<-l)-1,r>>=-l,l+=o;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===r)r=1-u;else{if(r===c)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,o),r-=u}return(g?-1:1)*s*Math.pow(2,r-o)}function v(e,t,n,o,i,r){var s,a,c,u=8*r-i-1,l=(1<<u)-1,d=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,g=o?0:r-1,f=o?1:-1,y=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+g]=255&a,g+=f,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[n+g]=255&s,g+=f,s/=256,u-=8);e[n+g-f]|=128*y}var S={}.toString,b=Array.isArray||function(e){return"[object Array]"==S.call(e)};function C(){return _.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function k(e,t){if(C()<t)throw new RangeError("Invalid typed array length");return _.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=_.prototype:(null===e&&(e=new _(t)),e.length=t),e}function _(e,t,n){if(!(_.TYPED_ARRAY_SUPPORT||this instanceof _))return new _(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return w(this,e)}return A(this,e,t,n)}function A(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);_.TYPED_ARRAY_SUPPORT?(e=t).__proto__=_.prototype:e=x(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!_.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|K(t,n);e=k(e,o);var i=e.write(t,n);i!==o&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(N(t)){var n=0|T(t.length);return 0===(e=k(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?k(e,0):x(e,t);if("Buffer"===t.type&&b(t.data))return x(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function I(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function w(e,t){if(I(t),e=k(e,t<0?0:0|T(t)),!_.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function x(e,t){var n=t.length<0?0:0|T(t.length);e=k(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function T(e){if(e>=C())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+C().toString(16)+" bytes");return 0|e}function N(e){return!(null==e||!e._isBuffer)}function K(e,t){if(N(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return ie(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return re(e).length;default:if(o)return ie(e).length;t=(""+t).toLowerCase(),o=!0}}function O(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return V(this,t,n);case"utf8":case"utf-8":return j(this,t,n);case"ascii":return z(this,t,n);case"latin1":case"binary":return F(this,t,n);case"base64":return B(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return W(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function R(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function D(e,t,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=_.from(t,o)),N(t))return 0===t.length?-1:P(e,t,n,o,i);if("number"==typeof t)return t&=255,_.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):P(e,[t],n,o,i);throw new TypeError("val must be string, number or Buffer")}function P(e,t,n,o,i){var r,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(r=n;r<a;r++)if(u(e,r)===u(t,-1===l?0:r-l)){if(-1===l&&(l=r),r-l+1===c)return l*s}else-1!==l&&(r-=r-l),l=-1}else for(n+c>a&&(n=a-c),r=n;r>=0;r--){for(var d=!0,h=0;h<c;h++)if(u(e,r+h)!==u(t,h)){d=!1;break}if(d)return r}return-1}function $(e,t,n,o){n=Number(n)||0;var i=e.length-n;o?(o=Number(o))>i&&(o=i):o=i;var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");o>r/2&&(o=r/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function L(e,t,n,o){return se(ie(t,e.length-n),e,n,o)}function M(e,t,n,o){return se(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function U(e,t,n,o){return M(e,t,n,o)}function Y(e,t,n,o){return se(re(t),e,n,o)}function H(e,t,n,o){return se(function(e,t){for(var n,o,i,r=[],s=0;s<e.length&&!((t-=2)<0);++s)o=(n=e.charCodeAt(s))>>8,i=n%256,r.push(i),r.push(o);return r}(t,e.length-n),e,n,o)}function B(e,t,n){return 0===t&&n===e.length?p(e):p(e.slice(t,n))}function j(e,t,n){n=Math.min(e.length,n);for(var o=[],i=t;i<n;){var r,s,a,c,u=e[i],l=null,d=u>239?4:u>223?3:u>191?2:1;if(i+d<=n)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(r=e[i+1]))&&(c=(31&u)<<6|63&r)>127&&(l=c);break;case 3:r=e[i+1],s=e[i+2],128==(192&r)&&128==(192&s)&&(c=(15&u)<<12|(63&r)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:r=e[i+1],s=e[i+2],a=e[i+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&r)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l),i+=d}return function(e){var t=e.length;if(t<=G)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=G));return n}(o)}_.TYPED_ARRAY_SUPPORT=void 0===l.TYPED_ARRAY_SUPPORT||l.TYPED_ARRAY_SUPPORT,C(),_.poolSize=8192,_._augment=function(e){return e.__proto__=_.prototype,e},_.from=function(e,t,n){return A(null,e,t,n)},_.TYPED_ARRAY_SUPPORT&&(_.prototype.__proto__=Uint8Array.prototype,_.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&_[Symbol.species]),_.alloc=function(e,t,n){return function(e,t,n,o){return I(t),t<=0?k(e,t):void 0!==n?"string"==typeof o?k(e,t).fill(n,o):k(e,t).fill(n):k(e,t)}(null,e,t,n)},_.allocUnsafe=function(e){return w(null,e)},_.allocUnsafeSlow=function(e){return w(null,e)},_.isBuffer=function(e){return null!=e&&(!!e._isBuffer||ae(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&ae(e.slice(0,0))}(e))},_.compare=function(e,t){if(!N(e)||!N(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,i=0,r=Math.min(n,o);i<r;++i)if(e[i]!==t[i]){n=e[i],o=t[i];break}return n<o?-1:o<n?1:0},_.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},_.concat=function(e,t){if(!b(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return _.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=_.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var r=e[n];if(!N(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(o,i),i+=r.length}return o},_.byteLength=K,_.prototype._isBuffer=!0,_.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)R(this,t,t+1);return this},_.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)R(this,t,t+3),R(this,t+1,t+2);return this},_.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)R(this,t,t+7),R(this,t+1,t+6),R(this,t+2,t+5),R(this,t+3,t+4);return this},_.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?j(this,0,e):O.apply(this,arguments)},_.prototype.equals=function(e){if(!N(e))throw new TypeError("Argument must be a Buffer");return this===e||0===_.compare(this,e)},_.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},_.prototype.compare=function(e,t,n,o,i){if(!N(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),t<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&t>=n)return 0;if(o>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var r=(i>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),c=this.slice(o,i),u=e.slice(t,n),l=0;l<a;++l)if(c[l]!==u[l]){r=c[l],s=u[l];break}return r<s?-1:s<r?1:0},_.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},_.prototype.indexOf=function(e,t,n){return D(this,e,t,n,!0)},_.prototype.lastIndexOf=function(e,t,n){return D(this,e,t,n,!1)},_.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var r=!1;;)switch(o){case"hex":return $(this,e,t,n);case"utf8":case"utf-8":return L(this,e,t,n);case"ascii":return M(this,e,t,n);case"latin1":case"binary":return U(this,e,t,n);case"base64":return Y(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return H(this,e,t,n);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),r=!0}},_.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var G=4096;function z(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(127&e[i]);return o}function F(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(e[i]);return o}function V(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var i="",r=t;r<n;++r)i+=oe(e[r]);return i}function W(e,t,n){for(var o=e.slice(t,n),i="",r=0;r<o.length;r+=2)i+=String.fromCharCode(o[r]+256*o[r+1]);return i}function J(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function Z(e,t,n,o,i,r){if(!N(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<r)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function X(e,t,n,o){t<0&&(t=65535+t+1);for(var i=0,r=Math.min(e.length-n,2);i<r;++i)e[n+i]=(t&255<<8*(o?i:1-i))>>>8*(o?i:1-i)}function q(e,t,n,o){t<0&&(t=4294967295+t+1);for(var i=0,r=Math.min(e.length-n,4);i<r;++i)e[n+i]=t>>>8*(o?i:3-i)&255}function Q(e,t,n,o,i,r){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function ee(e,t,n,o,i){return i||Q(e,0,n,4),v(e,t,n,o,23,4),n+4}function te(e,t,n,o,i){return i||Q(e,0,n,8),v(e,t,n,o,52,8),n+8}_.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),_.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=_.prototype;else{var i=t-e;n=new _(i,void 0);for(var r=0;r<i;++r)n[r]=this[r+e]}return n},_.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||J(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o},_.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||J(e,t,this.length);for(var o=this[e+--t],i=1;t>0&&(i*=256);)o+=this[e+--t]*i;return o},_.prototype.readUInt8=function(e,t){return t||J(e,1,this.length),this[e]},_.prototype.readUInt16LE=function(e,t){return t||J(e,2,this.length),this[e]|this[e+1]<<8},_.prototype.readUInt16BE=function(e,t){return t||J(e,2,this.length),this[e]<<8|this[e+1]},_.prototype.readUInt32LE=function(e,t){return t||J(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},_.prototype.readUInt32BE=function(e,t){return t||J(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},_.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||J(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},_.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||J(e,t,this.length);for(var o=t,i=1,r=this[e+--o];o>0&&(i*=256);)r+=this[e+--o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},_.prototype.readInt8=function(e,t){return t||J(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},_.prototype.readInt16LE=function(e,t){t||J(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},_.prototype.readInt16BE=function(e,t){t||J(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},_.prototype.readInt32LE=function(e,t){return t||J(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},_.prototype.readInt32BE=function(e,t){return t||J(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},_.prototype.readFloatLE=function(e,t){return t||J(e,4,this.length),E(this,e,!0,23,4)},_.prototype.readFloatBE=function(e,t){return t||J(e,4,this.length),E(this,e,!1,23,4)},_.prototype.readDoubleLE=function(e,t){return t||J(e,8,this.length),E(this,e,!0,52,8)},_.prototype.readDoubleBE=function(e,t){return t||J(e,8,this.length),E(this,e,!1,52,8)},_.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Z(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,r=0;for(this[t]=255&e;++r<n&&(i*=256);)this[t+r]=e/i&255;return t+n},_.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Z(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,r=1;for(this[t+i]=255&e;--i>=0&&(r*=256);)this[t+i]=e/r&255;return t+n},_.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,1,255,0),_.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},_.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,2,65535,0),_.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):X(this,e,t,!0),t+2},_.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,2,65535,0),_.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):X(this,e,t,!1),t+2},_.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,4,4294967295,0),_.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):q(this,e,t,!0),t+4},_.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,4,4294967295,0),_.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):q(this,e,t,!1),t+4},_.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Z(this,e,t,n,i-1,-i)}var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},_.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Z(this,e,t,n,i-1,-i)}var r=n-1,s=1,a=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},_.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,1,127,-128),_.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},_.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,2,32767,-32768),_.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):X(this,e,t,!0),t+2},_.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,2,32767,-32768),_.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):X(this,e,t,!1),t+2},_.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,4,2147483647,-2147483648),_.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):q(this,e,t,!0),t+4},_.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||Z(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),_.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):q(this,e,t,!1),t+4},_.prototype.writeFloatLE=function(e,t,n){return ee(this,e,t,!0,n)},_.prototype.writeFloatBE=function(e,t,n){return ee(this,e,t,!1,n)},_.prototype.writeDoubleLE=function(e,t,n){return te(this,e,t,!0,n)},_.prototype.writeDoubleBE=function(e,t,n){return te(this,e,t,!1,n)},_.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var i,r=o-n;if(this===e&&n<t&&t<o)for(i=r-1;i>=0;--i)e[i+t]=this[i+n];else if(r<1e3||!_.TYPED_ARRAY_SUPPORT)for(i=0;i<r;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},_.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!_.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var r;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(r=t;r<n;++r)this[r]=e;else{var s=N(e)?e:ie(new _(e,o).toString()),a=s.length;for(r=0;r<n-t;++r)this[r+t]=s[r%a]}return this};var ne=/[^+\/0-9A-Za-z-_]/g;function oe(e){return e<16?"0"+e.toString(16):e.toString(16)}function ie(e,t){var n;t=t||1/0;for(var o=e.length,i=null,r=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&r.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&r.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&r.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function re(e){return function(e){var t,n,o,i,r,s;f||y();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===e[a-2]?2:"="===e[a-1]?1:0,s=new g(3*a/4-r),o=r>0?a-4:a;var c=0;for(t=0,n=0;t<o;t+=4,n+=3)i=h[e.charCodeAt(t)]<<18|h[e.charCodeAt(t+1)]<<12|h[e.charCodeAt(t+2)]<<6|h[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===r?(i=h[e.charCodeAt(t)]<<2|h[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===r&&(i=h[e.charCodeAt(t)]<<10|h[e.charCodeAt(t+1)]<<4|h[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(ne,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function se(e,t,n,o){for(var i=0;i<o&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function ae(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class ce{constructor(e){this.enabled=!0,this.debug=!1,(null==e?void 0:e.debug)&&(this.debug=e.debug),(null==e?void 0:e.pkey)?this.ecies=t.fromHex(e.pkey):this.ecies=new t,this.debug&&(console.info("[ECIES] initialized secret: ",this.ecies.toHex()),console.info("[ECIES] initialized public: ",this.ecies.publicKey.toHex()),console.info("[ECIES] init with",this))}generateECIES(){this.ecies=new t}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let o=e;if(this.enabled)try{this.debug&&console.debug("ECIES::encrypt() using otherPublicKey",t);const i=_.from(e),r=n(t,i);o=_.from(r).toString("base64")}catch(n){throw this.debug&&(console.error("error encrypt:",n),console.error("private: ",this.ecies.toHex()),console.error("data: ",e),console.error("otherkey: ",t)),n}return o}decrypt(e){let t=e;if(this.enabled)try{this.debug&&console.debug("ECIES::decrypt() using privateKey",this.ecies.toHex());const n=_.from(e.toString(),"base64");t=o(this.ecies.toHex(),n).toString()}catch(t){throw this.debug&&(console.error("error decrypt",t),console.error("private: ",this.ecies.toHex()),console.error("encryptedData: ",e)),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){console.debug("ECIES::toString()",this.getKeyInfo())}}var ue={name:"@metamask/sdk-communication-layer",version:"0.12.0",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/browser/es/src/index.d.ts",files:["/dist"],scripts:{build:"rimraf dist && rollup -c --bundleConfigAsCjs","build:dev":"rimraf dist && NODE_ENV=dev rollup -c --bundleConfigAsCjs","build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","prepare-manifest:preview":"../../scripts/prepare-preview-manifest.sh","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:"jest","test:coverage":"jest --coverage","test:ci":"jest --coverage --passWithNoTests","test:dev":"jest",watch:"rollup -c -w"},dependencies:{"cross-fetch":"^3.1.5","date-fns":"^2.29.3",eciesjs:"^0.3.16",eventemitter2:"^6.4.5","socket.io-client":"^4.5.1",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^3.21.7","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.9.2","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^4.3.2"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1}}};const le="https://metamask-sdk-socket.metafi.codefi.network/",de=["polling","websocket"],he=6048e5,ge={METAMASK_GETPROVIDERSTATE:"metamask_getProviderState",ETH_REQUESTACCOUNTS:"eth_requestAccounts"};function fe(e){const{debug:t,context:n}=e;t&&console.debug(`RemoteCommunication::${n}::clean()`),e.channelConfig=void 0,e.ready=!1,e.originatorConnectStarted=!1}var ye,me,pe,Ee,ve;!function(e){e.DISCONNECTED="disconnected",e.WAITING="waiting",e.TIMEOUT="timeout",e.LINKED="linked",e.PAUSED="paused",e.TERMINATED="terminated"}(ye||(ye={})),function(e){e.KEY_INFO="key_info",e.SERVICE_STATUS="service_status",e.PROVIDER_UPDATE="provider_update",e.RPC_UPDATE="rpc_update",e.KEYS_EXCHANGED="keys_exchanged",e.JOIN_CHANNEL="join_channel",e.CHANNEL_CREATED="channel_created",e.CLIENTS_CONNECTED="clients_connected",e.CLIENTS_DISCONNECTED="clients_disconnected",e.CLIENTS_WAITING="clients_waiting",e.CLIENTS_READY="clients_ready",e.SOCKET_DISCONNECTED="socket_disconnected",e.SOCKET_RECONNECT="socket_reconnect",e.OTP="otp",e.SDK_RPC_CALL="sdk_rpc_call",e.AUTHORIZED="authorized",e.CONNECTION_STATUS="connection_status",e.MESSAGE="message",e.TERMINATE="terminate"}(me||(me={})),function(e){e.KEY_EXCHANGE="key_exchange"}(pe||(pe={})),function(e){e.KEY_HANDSHAKE_START="key_handshake_start",e.KEY_HANDSHAKE_CHECK="key_handshake_check",e.KEY_HANDSHAKE_SYN="key_handshake_SYN",e.KEY_HANDSHAKE_SYNACK="key_handshake_SYNACK",e.KEY_HANDSHAKE_ACK="key_handshake_ACK",e.KEY_HANDSHAKE_NONE="none"}(Ee||(Ee={}));class Se extends i{constructor({communicationLayer:e,otherPublicKey:t,context:n,ecies:o,logging:i}){super(),this.keysExchanged=!1,this.step=Ee.KEY_HANDSHAKE_NONE,this.debug=!1,this.context=n,this.myECIES=new ce(Object.assign(Object.assign({},o),{debug:null==i?void 0:i.eciesLayer})),this.communicationLayer=e,this.myPublicKey=this.myECIES.getPublicKey(),this.debug=!0===(null==i?void 0:i.keyExchangeLayer),t&&this.setOtherPublicKey(t),this.communicationLayer.on(pe.KEY_EXCHANGE,this.onKeyExchangeMessage.bind(this))}onKeyExchangeMessage(e){this.debug&&console.debug(`KeyExchange::${this.context}::onKeyExchangeMessage() keysExchanged=${this.keysExchanged}`,e);const{message:t}=e;this.keysExchanged&&this.debug&&console.log(`KeyExchange::${this.context}::onKeyExchangeMessage received handshake while already exchanged. step=${this.step} otherPubKey=${this.otherPublicKey}`),t.type===Ee.KEY_HANDSHAKE_SYN?(this.checkStep([Ee.KEY_HANDSHAKE_NONE,Ee.KEY_HANDSHAKE_ACK]),this.debug&&console.debug("KeyExchange::KEY_HANDSHAKE_SYN",t),t.pubkey&&this.setOtherPublicKey(t.pubkey),this.communicationLayer.sendMessage({type:Ee.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey}),this.step=Ee.KEY_HANDSHAKE_ACK,this.emit(me.KEY_INFO,this.step)):t.type===Ee.KEY_HANDSHAKE_SYNACK?(this.checkStep([Ee.KEY_HANDSHAKE_SYNACK,Ee.KEY_HANDSHAKE_NONE]),this.debug&&console.debug("KeyExchange::KEY_HANDSHAKE_SYNACK"),t.pubkey&&this.setOtherPublicKey(t.pubkey),this.communicationLayer.sendMessage({type:Ee.KEY_HANDSHAKE_ACK}),this.keysExchanged=!0,this.step=Ee.KEY_HANDSHAKE_NONE,this.emit(me.KEYS_EXCHANGED)):t.type===Ee.KEY_HANDSHAKE_ACK&&(this.debug&&console.debug("KeyExchange::KEY_HANDSHAKE_ACK set keysExchanged to true!"),this.checkStep([Ee.KEY_HANDSHAKE_ACK,Ee.KEY_HANDSHAKE_NONE]),this.keysExchanged=!0,this.step=Ee.KEY_HANDSHAKE_NONE,this.emit(me.KEYS_EXCHANGED))}resetKeys(e){this.clean(),this.myECIES=new ce(e)}clean(){this.debug&&console.debug(`KeyExchange::${this.context}::clean reset handshake state`),this.step=Ee.KEY_HANDSHAKE_NONE,this.emit(me.KEY_INFO,this.step),this.keysExchanged=!1}start({isOriginator:e,force:t}){this.debug&&console.debug(`KeyExchange::${this.context}::start isOriginator=${e} step=${this.step} force=${t} keysExchanged=${this.keysExchanged}`),e?!this.keysExchanged&&this.step===Ee.KEY_HANDSHAKE_NONE||t?(this.debug&&console.debug(`KeyExchange::${this.context}::start -- start key exchange (force=${t}) -- step=${this.step}`,this.step),this.clean(),this.step=Ee.KEY_HANDSHAKE_SYNACK,this.emit(me.KEY_INFO,this.step),this.communicationLayer.sendMessage({type:Ee.KEY_HANDSHAKE_SYN,pubkey:this.myPublicKey})):this.debug&&console.debug(`KeyExchange::${this.context}::start -- key exchange already ${this.keysExchanged?"done":"in progress"} -- aborted.`,this.step):this.keysExchanged&&!0!==t?this.debug&&console.debug("KeyExchange::start don't send KEY_HANDSHAKE_START -- exchange already done."):(this.communicationLayer.sendMessage({type:Ee.KEY_HANDSHAKE_START}),this.clean())}checkStep(e){if(e.length>0&&-1===e.indexOf(this.step.toString()))throw new Error(`Wrong Step "${this.step}" not within ${e}`)}setKeysExchanged(e){this.keysExchanged=e}areKeysExchanged(){return this.keysExchanged}getMyPublicKey(){return this.myPublicKey}getOtherPublicKey(){return this.otherPublicKey}setOtherPublicKey(e){this.debug&&console.debug("KeyExchange::setOtherPubKey()",e),this.otherPublicKey=e}encryptMessage(e){if(!this.otherPublicKey)throw new Error("encryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.encrypt(e,this.otherPublicKey)}decryptMessage(e){if(!this.otherPublicKey)throw new Error("decryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.decrypt(e)}getKeyInfo(){return{ecies:Object.assign(Object.assign({},this.myECIES.getKeyInfo()),{otherPubKey:this.otherPublicKey}),step:this.step,keysExchanged:this.areKeysExchanged()}}toString(){const e={keyInfo:this.getKeyInfo(),keysExchanged:this.keysExchanged,step:this.step};return JSON.stringify(e)}}!function(e){e.TERMINATE="terminate",e.ANSWER="answer",e.OFFER="offer",e.CANDIDATE="candidate",e.JSONRPC="jsonrpc",e.WALLET_INFO="wallet_info",e.ORIGINATOR_INFO="originator_info",e.PAUSE="pause",e.OTP="otp",e.AUTHORIZED="authorized",e.PING="ping",e.READY="ready"}(ve||(ve={}));const be=e=>new Promise((t=>{setTimeout(t,e)})),Ce=(e,t,n=200)=>c(void 0,void 0,void 0,(function*(){let o;const i=Date.now();let r=!1;for(;!r;){if(r=Date.now()-i>3e5,o=t[e],void 0!==o.elapsedTime)return o;yield be(n)}throw new Error(`RPC ${e} timed out`)})),ke=e=>c(void 0,void 0,void 0,(function*(){var t,n,o,i,r;return e.state.debug&&console.debug(`SocketService::connectAgain instance.state.socket?.connected=${null===(t=e.state.socket)||void 0===t?void 0:t.connected} trying to reconnect after socketio disconnection`,e),yield be(200),(null===(n=e.state.socket)||void 0===n?void 0:n.connected)||(e.state.resumed=!0,null===(o=e.state.socket)||void 0===o||o.connect(),e.emit(me.SOCKET_RECONNECT),null===(i=e.state.socket)||void 0===i||i.emit(me.JOIN_CHANNEL,e.state.channelId,`${e.state.context}connect_again`)),yield be(100),null===(r=e.state.socket)||void 0===r?void 0:r.connected}));function _e(e){return t=>{e.state.debug&&console.debug(`SocketService::on 'disconnect' manualDisconnect=${e.state.manualDisconnect}`,t),e.state.manualDisconnect||(e.emit(me.SOCKET_DISCONNECTED),function(e){"undefined"!=typeof window&&"undefined"!=typeof document&&(e.state.debug&&console.debug(`SocketService::checkFocus hasFocus=${document.hasFocus()}`,e),document.hasFocus()?ke(e).then((t=>{e.state.debug&&console.debug(`SocketService::checkFocus reconnectSocket success=${t}`,e)})).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)})):window.addEventListener("focus",(()=>{ke(e).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)}))}),{once:!0}))}(e))}}const Ae=[{event:"clients_connected",handler:function(e,t){return n=>c(this,void 0,void 0,(function*(){var n,o,i,r,s,a,c,u;e.state.debug&&console.debug(`SocketService::${e.state.context}::setupChannelListener::on 'clients_connected-${t}'  resumed=${e.state.resumed}  clientsPaused=${e.state.clientsPaused} keysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()} isOriginator=${e.state.isOriginator}`),e.emit(me.CLIENTS_CONNECTED,{isOriginator:e.state.isOriginator,keysExchanged:null===(o=e.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged(),context:e.state.context}),e.state.resumed?(e.state.isOriginator||(e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'clients_connected' / keysExchanged=${null===(i=e.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged()} -- backward compatibility`),null===(r=e.state.keyExchange)||void 0===r||r.start({isOriginator:null!==(s=e.state.isOriginator)&&void 0!==s&&s})),e.state.resumed=!1):e.state.clientsPaused?console.debug("SocketService::on 'clients_connected' skip sending originatorInfo on pause"):e.state.isOriginator||(e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'clients_connected' / keysExchanged=${null===(a=e.state.keyExchange)||void 0===a?void 0:a.areKeysExchanged()} -- backward compatibility`),null===(c=e.state.keyExchange)||void 0===c||c.start({isOriginator:null!==(u=e.state.isOriginator)&&void 0!==u&&u,force:!0})),e.state.clientsConnected=!0,e.state.clientsPaused=!1}))}},{event:"channel_created",handler:function(e,t){return n=>{e.state.debug&&console.debug(`SocketService::${e.state.context}::setupChannelListener::on 'channel_created-${t}'`,n),e.emit(me.CHANNEL_CREATED,n)}}},{event:"clients_disconnected",handler:function(e,t){return()=>{var n;e.state.clientsConnected=!1,e.state.debug&&console.debug(`SocketService::${e.state.context}::setupChannelListener::on 'clients_disconnected-${t}'`),e.state.isOriginator&&!e.state.clientsPaused&&(null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.emit(me.CLIENTS_DISCONNECTED,t)}}},{event:"message",handler:function(e,t){return({id:n,message:o,error:i})=>{var r,s,a,c,u,l,d,h,g,f,y,m,p,E,v;if(e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' ${t} keysExchanged=${null===(r=e.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged()}`,o),i)throw e.state.debug&&console.debug(`\n      SocketService::${e.state.context}::on 'message' error=${i}`),new Error(i);try{!function(e,t){if(t!==e.channelId)throw e.debug&&console.error(`Wrong id ${t} - should be ${e.channelId}`),new Error("Wrong id")}(e.state,n)}catch(e){return void console.error("ignore message --- wrong id ",o)}if(e.state.isOriginator&&(null==o?void 0:o.type)===Ee.KEY_HANDSHAKE_START)return e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' received HANDSHAKE_START isOriginator=${e.state.isOriginator}`,o),void(null===(s=e.state.keyExchange)||void 0===s||s.start({isOriginator:null!==(a=e.state.isOriginator)&&void 0!==a&&a,force:!0}));if((null==o?void 0:o.type)===ve.PING)return e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' ping `),void e.emit(me.MESSAGE,{message:{type:"ping"}});if(e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' originator=${e.state.isOriginator}, type=${null==o?void 0:o.type}, keysExchanged=${null===(c=e.state.keyExchange)||void 0===c?void 0:c.areKeysExchanged()}`),null===(u=null==o?void 0:o.type)||void 0===u?void 0:u.startsWith("key_handshake"))return e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' emit KEY_EXCHANGE`,o),void e.emit(pe.KEY_EXCHANGE,{message:o,context:e.state.context});if(null===(l=e.state.keyExchange)||void 0===l?void 0:l.areKeysExchanged()){if(-1!==o.toString().indexOf("type"))return console.warn("SocketService::on 'message' received non encrypted unkwown message"),void e.emit(me.MESSAGE,o)}else{let t=!1;try{null===(d=e.state.keyExchange)||void 0===d||d.decryptMessage(o),t=!0}catch(e){}if(!t)return e.state.isOriginator?null===(g=e.state.keyExchange)||void 0===g||g.start({isOriginator:null!==(f=e.state.isOriginator)&&void 0!==f&&f}):e.sendMessage({type:Ee.KEY_HANDSHAKE_START}),void console.warn(`Message ignored because invalid key exchange status. step=${null===(y=e.state.keyExchange)||void 0===y?void 0:y.getKeyInfo().step}`,null===(m=e.state.keyExchange)||void 0===m?void 0:m.getKeyInfo(),o);console.warn("Invalid key exchange status detected --- updating it."),null===(h=e.state.keyExchange)||void 0===h||h.setKeysExchanged(!0)}const S=null===(p=e.state.keyExchange)||void 0===p?void 0:p.decryptMessage(o),b=JSON.parse(null!=S?S:"{}");if((null==b?void 0:b.type)===ve.PAUSE?e.state.clientsPaused=!0:e.state.clientsPaused=!1,e.state.isOriginator&&b.data){const t=b.data,n=e.state.rpcMethodTracker[t.id];if(n){const o=Date.now()-n.timestamp;e.state.debug&&console.debug(`SocketService::${e.state.context}::on 'message' received answer for id=${t.id} method=${n.method} responseTime=${o}`,b);const i=Object.assign(Object.assign({},n),{result:t.result,error:t.error?{code:null===(E=t.error)||void 0===E?void 0:E.code,message:null===(v=t.error)||void 0===v?void 0:v.message}:void 0,elapsedTime:o});e.state.rpcMethodTracker[t.id]=i,e.emit(me.RPC_UPDATE),e.state.debug&&console.debug("HACK (wallet <7.3) update rpcMethodTracker",i),e.emit(me.AUTHORIZED)}}e.emit(me.MESSAGE,{message:b})}}},{event:"clients_waiting_to_join",handler:function(e,t){return n=>{e.state.debug&&console.debug(`SocketService::${e.state.context}::setupChannelListener::on 'clients_waiting_to_join-${t}'`,n),e.emit(me.CLIENTS_WAITING,n)}}}],Ie=[{event:me.KEY_INFO,handler:function(e){return t=>{e.state.debug&&console.debug("SocketService::on 'KEY_INFO'",t),e.emit(me.KEY_INFO,t)}}},{event:me.KEYS_EXCHANGED,handler:function(e){return()=>{var t,n;e.state.debug&&console.debug(`SocketService::on 'keys_exchanged' keyschanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`),e.emit(me.KEYS_EXCHANGED,{keysExchanged:null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged(),isOriginator:e.state.isOriginator});const o={keyInfo:e.getKeyInfo()};e.emit(me.SERVICE_STATUS,o)}}}];function we(e,t){e.state.debug&&console.debug(`SocketService::${e.state.context}::setupChannelListener setting socket listeners for channel ${t}...`);const{socket:n}=e.state,{keyExchange:o}=e.state;e.state.setupChannelListeners&&console.warn(`SocketService::${e.state.context}::setupChannelListener socket listeners already set up for channel ${t}`),n&&e.state.isOriginator&&(e.state.debug&&(null==n||n.io.on("error",(t=>{console.debug(`SocketService::${e.state.context}::setupChannelListener socket event=error`,t)})),null==n||n.io.on("reconnect",(t=>{console.debug(`SocketService::${e.state.context}::setupChannelListener socket event=reconnect`,t)})),null==n||n.io.on("reconnect_error",(t=>{console.debug(`SocketService::${e.state.context}::setupChannelListener socket event=reconnect_error`,t)})),null==n||n.io.on("reconnect_failed",(()=>{console.debug(`SocketService::${e.state.context}::setupChannelListener socket event=reconnect_failed`)})),null==n||n.io.on("ping",(()=>{console.debug(`SocketService::${e.state.context}::setupChannelListener socket event=ping`)}))),null==n||n.on("disconnect",(t=>(console.log(`MetaMaskSDK socket disconnected '${t}' begin recovery...`),_e(e)(t))))),Ae.forEach((({event:o,handler:i})=>{const r=`${o}-${t}`;null==n||n.on(r,i(e,t))})),Ie.forEach((({event:t,handler:n})=>{null==o||o.on(t,n(e))})),e.state.setupChannelListeners=!0}function xe(e,t){var n,o;if(!e.state.channelId)throw new Error("Create a channel first");e.state.debug&&console.debug(`SocketService::${e.state.context}::sendMessage() areKeysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`,t);(null===(o=null==t?void 0:t.type)||void 0===o?void 0:o.startsWith("key_handshake"))?function(e,t){var n;e.state.debug&&console.debug(`SocketService::${e.state.context}::sendMessage()`,t),null===(n=e.state.socket)||void 0===n||n.emit(me.MESSAGE,{id:e.state.channelId,context:e.state.context,message:t})}(e,t):(!function(e,t){var n;if(!(null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()))throw e.state.debug&&console.debug(`SocketService::${e.state.context}::sendMessage() ERROR keys not exchanged`,t),new Error("Keys not exchanged BBB")}(e,t),function(e,t){var n;const o=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"",i=null==t?void 0:t.id;e.state.isOriginator&&i&&(e.state.rpcMethodTracker[i]={timestamp:Date.now(),method:o},e.emit(me.RPC_UPDATE))}(e,t),function(e,t){var n,o;const i=null===(n=e.state.keyExchange)||void 0===n?void 0:n.encryptMessage(JSON.stringify(t)),r={id:e.state.channelId,context:e.state.context,message:i,plaintext:e.state.hasPlaintext?JSON.stringify(t):void 0};e.state.debug&&console.debug(`SocketService::${e.state.context}::sendMessage()`,r),t.type===ve.TERMINATE&&(e.state.manualDisconnect=!0),null===(o=e.state.socket)||void 0===o||o.emit(me.MESSAGE,r)}(e,t),function(e,t){var n;return c(this,void 0,void 0,(function*(){const o=null==t?void 0:t.id,i=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"";if(e.state.isOriginator&&o)try{const n=yield Ce(o,e.state.rpcMethodTracker,200);e.state.debug&&console.debug(`SocketService::waitForRpc id=${t.id} ${i} ( ${n.elapsedTime} ms)`,n.result)}catch(e){console.warn(`Error rpcId=${t.id} ${i}`,e)}}))}(e,t).catch((e=>{console.warn("Error handleRpcReplies",e)})))}class Te extends i{constructor({otherPublicKey:e,reconnect:t,communicationLayerPreference:n,transports:o,communicationServerUrl:i,context:r,ecies:s,logging:c}){super(),this.state={clientsConnected:!1,clientsPaused:!1,manualDisconnect:!1,rpcMethodTracker:{},hasPlaintext:!1,communicationServerUrl:""},this.state.resumed=t,this.state.context=r,this.state.communicationLayerPreference=n,this.state.debug=!0===(null==c?void 0:c.serviceLayer),this.state.communicationServerUrl=i,this.state.hasPlaintext=this.state.communicationServerUrl!==le&&!0===(null==c?void 0:c.plaintext);const u={autoConnect:!1,transports:de};o&&(u.transports=o),this.state.debug&&console.debug(`SocketService::constructor() Socket IO url: ${this.state.communicationServerUrl}`),this.state.socket=a(i,u);const l={communicationLayer:this,otherPublicKey:e,sendPublicKey:!1,context:this.state.context,ecies:s,logging:c};this.state.keyExchange=new Se(l)}resetKeys(){return(e=this).state.debug&&console.debug("SocketService::resetKeys()"),void(null===(t=e.state.keyExchange)||void 0===t||t.resetKeys());var e,t}createChannel(){return function(e){var t,n,o,i;e.state.debug&&console.debug(`SocketService::${e.state.context}::createChannel()`),(null===(t=e.state.socket)||void 0===t?void 0:t.connected)||null===(n=e.state.socket)||void 0===n||n.connect(),e.state.manualDisconnect=!1,e.state.isOriginator=!0;const r=s();return e.state.channelId=r,we(e,r),null===(o=e.state.socket)||void 0===o||o.emit(me.JOIN_CHANNEL,r,`${e.state.context}createChannel`),{channelId:r,pubKey:(null===(i=e.state.keyExchange)||void 0===i?void 0:i.getMyPublicKey())||""}}(this)}connectToChannel({channelId:e,isOriginator:t=!1,withKeyExchange:n=!1}){return function({options:e,instance:t}){var n,o,i,r;const{channelId:s,withKeyExchange:a,isOriginator:c}=e;if(t.state.debug&&console.debug(`SocketService::${t.state.context}::connectToChannel() channelId=${s} isOriginator=${c}`,null===(n=t.state.keyExchange)||void 0===n?void 0:n.toString()),null===(o=t.state.socket)||void 0===o?void 0:o.connected)throw new Error("socket already connected");t.state.manualDisconnect=!1,null===(i=t.state.socket)||void 0===i||i.connect(),t.state.withKeyExchange=a,t.state.isOriginator=c,t.state.channelId=s,we(t,s),null===(r=t.state.socket)||void 0===r||r.emit(me.JOIN_CHANNEL,s,`${t.state.context}_connectToChannel`)}({options:{channelId:e,isOriginator:t,withKeyExchange:n},instance:this})}getKeyInfo(){return this.state.keyExchange.getKeyInfo()}keyCheck(){var e,t;null===(t=(e=this).state.socket)||void 0===t||t.emit(me.MESSAGE,{id:e.state.channelId,context:e.state.context,message:{type:Ee.KEY_HANDSHAKE_CHECK,pubkey:e.getKeyInfo().ecies.otherPubKey}})}getKeyExchange(){return this.state.keyExchange}sendMessage(e){return xe(this,e)}ping(){return(e=this).state.debug&&console.debug(`SocketService::${e.state.context}::ping() originator=${e.state.isOriginator} keysExchanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`),e.state.isOriginator&&((null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())?(console.warn(`SocketService::${e.state.context}::ping() sending READY message`),e.sendMessage({type:ve.READY})):(console.warn(`SocketService::${e.state.context}::ping() starting key exchange`),null===(o=e.state.keyExchange)||void 0===o||o.start({isOriginator:null!==(i=e.state.isOriginator)&&void 0!==i&&i}))),void(null===(r=e.state.socket)||void 0===r||r.emit(me.MESSAGE,{id:e.state.channelId,context:e.state.context,message:{type:ve.PING}}));var e,t,n,o,i,r}pause(){return(e=this).state.debug&&console.debug(`SocketService::${e.state.context}::pause()`),e.state.manualDisconnect=!0,(null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged())&&e.sendMessage({type:ve.PAUSE}),void(null===(n=e.state.socket)||void 0===n||n.disconnect());var e,t,n}isConnected(){var e;return null===(e=this.state.socket)||void 0===e?void 0:e.connected}resume(){return(e=this).state.debug&&console.debug(`SocketService::${e.state.context}::resume() connected=${null===(t=e.state.socket)||void 0===t?void 0:t.connected} manualDisconnect=${e.state.manualDisconnect} resumed=${e.state.resumed} keysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`),(null===(o=e.state.socket)||void 0===o?void 0:o.connected)?e.state.debug&&console.debug("SocketService::resume() already connected."):(null===(i=e.state.socket)||void 0===i||i.connect(),e.state.debug&&console.debug(`SocketService::resume() after connecting socket --\x3e connected=${null===(r=e.state.socket)||void 0===r?void 0:r.connected}`),null===(s=e.state.socket)||void 0===s||s.emit(me.JOIN_CHANNEL,e.state.channelId,`${e.state.context}_resume`)),(null===(a=e.state.keyExchange)||void 0===a?void 0:a.areKeysExchanged())?e.state.isOriginator||e.sendMessage({type:ve.READY}):e.state.isOriginator||null===(c=e.state.keyExchange)||void 0===c||c.start({isOriginator:null!==(u=e.state.isOriginator)&&void 0!==u&&u}),e.state.manualDisconnect=!1,void(e.state.resumed=!0);var e,t,n,o,i,r,s,a,c,u}getRPCMethodTracker(){return this.state.rpcMethodTracker}disconnect(e){return function(e,t){var n,o;e.state.debug&&console.debug(`SocketService::${e.state.context}::disconnect()`,t),(null==t?void 0:t.terminate)&&(e.state.channelId=t.channelId,null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.state.rpcMethodTracker={},e.state.manualDisconnect=!0,null===(o=e.state.socket)||void 0===o||o.disconnect()}(this,e)}}var Ne,Ke,Oe,Re;function De(e){return()=>c(this,void 0,void 0,(function*(){var t,n,o;const{state:i}=e;if(i.authorized)return;yield(()=>c(this,void 0,void 0,(function*(){for(;!i.walletInfo;)yield be(500)})))();const r="7.3".localeCompare((null===(t=i.walletInfo)||void 0===t?void 0:t.version)||"");if(i.debug&&console.debug(`RemoteCommunication HACK 'authorized' version=${null===(n=i.walletInfo)||void 0===n?void 0:n.version} compareValue=${r}`),1!==r)return;const s=i.platformType===Ke.MobileWeb||i.platformType===Ke.ReactNative||i.platformType===Ke.MetaMaskMobileWebview;i.debug&&console.debug(`RemoteCommunication HACK 'authorized' platform=${i.platformType} secure=${s} channel=${i.channelId} walletVersion=${null===(o=i.walletInfo)||void 0===o?void 0:o.version}`),s&&(i.authorized=!0,e.emit(me.AUTHORIZED))}))}function Pe(e){return t=>{const{state:n}=e;n.debug&&console.debug(`RemoteCommunication::${n.context}::on 'channel_created' channelId=${t}`),e.emit(me.CHANNEL_CREATED,t)}}function $e(e,t){return()=>{var n,o,i,r;const{state:s}=e;if(s.debug&&console.debug(`RemoteCommunication::on 'clients_connected' channel=${s.channelId} keysExchanged=${null===(o=null===(n=s.communicationLayer)||void 0===n?void 0:n.getKeyInfo())||void 0===o?void 0:o.keysExchanged}`),s.analytics){const e=s.isOriginator?Oe.REQUEST:Oe.REQUEST_MOBILE;u(Object.assign(Object.assign({id:null!==(i=s.channelId)&&void 0!==i?i:"",event:s.reconnection?Oe.RECONNECT:e},s.originatorInfo),{commLayer:t,sdkVersion:s.sdkVersion,walletVersion:null===(r=s.walletInfo)||void 0===r?void 0:r.version,commLayerVersion:ue.version}),s.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}s.clientsConnected=!0,s.originatorInfoSent=!1,e.emit(me.CLIENTS_CONNECTED)}}function Le(e,t){return n=>{var o;const{state:i}=e;i.debug&&console.debug(`RemoteCommunication::${i.context}]::on 'clients_disconnected' channelId=${n}`),i.clientsConnected=!1,e.emit(me.CLIENTS_DISCONNECTED,i.channelId),e.setConnectionStatus(ye.DISCONNECTED),i.ready=!1,i.authorized=!1,i.analytics&&i.channelId&&u({id:i.channelId,event:Oe.DISCONNECTED,sdkVersion:i.sdkVersion,commLayer:t,commLayerVersion:ue.version,walletVersion:null===(o=i.walletInfo)||void 0===o?void 0:o.version},i.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}}function Me(e){return t=>{var n;const{state:o}=e;if(o.debug&&console.debug(`RemoteCommunication::${o.context}::on 'clients_waiting' numberUsers=${t} ready=${o.ready} autoStarted=${o.originatorConnectStarted}`),e.setConnectionStatus(ye.WAITING),e.emit(me.CLIENTS_WAITING,t),o.originatorConnectStarted){o.debug&&console.debug(`RemoteCommunication::on 'clients_waiting' watch autoStarted=${o.originatorConnectStarted} timeout`,o.autoConnectOptions);const t=(null===(n=o.autoConnectOptions)||void 0===n?void 0:n.timeout)||3e3,i=setTimeout((()=>{o.debug&&console.debug(`RemoteCommunication::on setTimeout(${t}) terminate channelConfig`,o.autoConnectOptions),o.originatorConnectStarted=!1,o.ready||e.setConnectionStatus(ye.TIMEOUT),clearTimeout(i)}),t)}}}function Ue(e,t){return n=>{var o,i,r,s,a;const{state:c}=e;c.debug&&console.debug(`RemoteCommunication::${c.context}::on commLayer.'keys_exchanged' channel=${c.channelId}`,n),(null===(i=null===(o=c.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.keysExchanged)&&e.setConnectionStatus(ye.LINKED),function(e,t){var n,o,i,r;const{state:s}=e;s.debug&&console.debug(`RemoteCommunication::setLastActiveDate() channel=${s.channelId}`,t);const a={channelId:null!==(n=s.channelId)&&void 0!==n?n:"",validUntil:null!==(i=null===(o=s.channelConfig)||void 0===o?void 0:o.validUntil)&&void 0!==i?i:0,lastActive:t.getTime()};null===(r=s.storageManager)||void 0===r||r.persistChannelConfig(a)}(e,new Date),c.analytics&&c.channelId&&u({id:c.channelId,event:n.isOriginator?Oe.CONNECTED:Oe.CONNECTED_MOBILE,sdkVersion:c.sdkVersion,commLayer:t,commLayerVersion:ue.version,walletVersion:null===(r=c.walletInfo)||void 0===r?void 0:r.version},c.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),c.isOriginator=n.isOriginator,n.isOriginator||(null===(s=c.communicationLayer)||void 0===s||s.sendMessage({type:ve.READY}),c.ready=!0,c.paused=!1),n.isOriginator&&!c.originatorInfoSent&&(null===(a=c.communicationLayer)||void 0===a||a.sendMessage({type:ve.ORIGINATOR_INFO,originatorInfo:c.originatorInfo,originator:c.originatorInfo}),c.originatorInfoSent=!0)}}function Ye(e,t){const{state:n}=t;if(n.debug&&console.debug(`RemoteCommunication::${n.context}::on 'message' typeof=${typeof e}`,e),t.state.ready=!0,n.isOriginator||e.type!==ve.ORIGINATOR_INFO)if(n.isOriginator&&e.type===ve.WALLET_INFO)!function(e,t){const{state:n}=e;n.walletInfo=t.walletInfo,n.paused=!1}(t,e);else{if(e.type===ve.TERMINATE)!function(e){const{state:t}=e;t.isOriginator&&(ze({options:{terminate:!0,sendMessage:!1},instance:e}),console.debug(),e.emit(me.TERMINATE))}(t);else if(e.type===ve.PAUSE)!function(e){const{state:t}=e;t.paused=!0,e.setConnectionStatus(ye.PAUSED)}(t);else if(e.type===ve.READY&&n.isOriginator)!function(e){const{state:t}=e;e.setConnectionStatus(ye.LINKED);const n=t.paused;t.paused=!1,e.emit(me.CLIENTS_READY,{isOriginator:t.isOriginator,walletInfo:t.walletInfo}),n&&(t.authorized=!0,e.emit(me.AUTHORIZED))}(t);else{if(e.type===ve.OTP&&n.isOriginator)return void function(e,t){var n;const{state:o}=e;e.emit(me.OTP,t.otpAnswer),1==="6.6".localeCompare((null===(n=o.walletInfo)||void 0===n?void 0:n.version)||"")&&(console.warn("RemoteCommunication::on 'otp' -- backward compatibility <6.6 -- triger eth_requestAccounts"),e.emit(me.SDK_RPC_CALL,{method:ge.ETH_REQUESTACCOUNTS,params:[]}))}(t,e);e.type===ve.AUTHORIZED&&n.isOriginator&&function(e){const{state:t}=e;t.authorized=!0,e.emit(me.AUTHORIZED)}(t)}t.emit(me.MESSAGE,e)}else!function(e,t){var n;const{state:o}=e;null===(n=o.communicationLayer)||void 0===n||n.sendMessage({type:ve.WALLET_INFO,walletInfo:o.walletInfo}),o.originatorInfo=t.originatorInfo||t.originator,e.emit(me.CLIENTS_READY,{isOriginator:o.isOriginator,originatorInfo:o.originatorInfo}),o.paused=!1}(t,e)}function He(e,t){var n,o;return c(this,void 0,void 0,(function*(){const{state:i}=e;i.debug&&console.log(`RemoteCommunication::${i.context}::sendMessage paused=${i.paused} ready=${i.ready} authorized=${i.authorized} socket=${null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected()} clientsConnected=${i.clientsConnected} status=${i._connectionStatus}`,t),!i.paused&&i.ready&&(null===(o=i.communicationLayer)||void 0===o?void 0:o.isConnected())&&i.clientsConnected||(i.debug&&console.log(`RemoteCommunication::${i.context}::sendMessage  SKIP message waiting for MM mobile readiness.`),yield new Promise((t=>{e.once(me.CLIENTS_READY,t)})),i.debug&&console.log(`RemoteCommunication::${i.context}::sendMessage  AFTER SKIP / READY -- sending pending message`));try{yield function(e,t){return c(this,void 0,void 0,(function*(){return new Promise((n=>{var o,i,r,s;const{state:a}=e;if(a.debug&&console.log(`RemoteCommunication::${a.context}::sendMessage::handleAuthorization ready=${a.ready} authorized=${a.authorized} method=${t.method}`),1==="7.3".localeCompare((null===(o=a.walletInfo)||void 0===o?void 0:o.version)||""))return a.debug&&console.debug(`compatibility hack wallet version > ${null===(i=a.walletInfo)||void 0===i?void 0:i.version}`),null===(r=a.communicationLayer)||void 0===r||r.sendMessage(t),void n();!a.isOriginator||a.authorized?(null===(s=a.communicationLayer)||void 0===s||s.sendMessage(t),n()):e.once(me.AUTHORIZED,(()=>{var e;a.debug&&console.log(`RemoteCommunication::${a.context}::sendMessage  AFTER SKIP / AUTHORIZED -- sending pending message`),null===(e=a.communicationLayer)||void 0===e||e.sendMessage(t),n()}))}))}))}(e,t)}catch(e){throw console.error(`RemoteCommunication::${i.context}::sendMessage  ERROR`,e),e}}))}function Be(e){return t=>{let n=t;t.message&&(n=n.message),Ye(n,e)}}function je(e){return()=>{const{state:t}=e;t.debug&&console.debug("RemoteCommunication::on 'socket_reconnect' -- reset key exchange status / set ready to false"),t.ready=!1,fe(t)}}function Ge(e){return()=>{const{state:t}=e;t.debug&&console.debug("RemoteCommunication::on 'socket_Disconnected' set ready to false"),t.ready=!1}}function ze({options:e,instance:t}){var n,o,i,r,a,c;const{state:u}=t;u.debug&&console.debug(`RemoteCommunication::disconnect() channel=${u.channelId}`,e),u.ready=!1,u.paused=!1,(null==e?void 0:e.terminate)?(null===(n=u.storageManager)||void 0===n||n.terminate(null!==(o=u.channelId)&&void 0!==o?o:""),(null===(i=u.communicationLayer)||void 0===i?void 0:i.getKeyInfo().keysExchanged)&&(null==e?void 0:e.sendMessage)&&(null===(r=u.communicationLayer)||void 0===r||r.sendMessage({type:ve.TERMINATE})),u.channelId=s(),e.channelId=u.channelId,u.channelConfig=void 0,u.originatorConnectStarted=!1,null===(a=u.communicationLayer)||void 0===a||a.disconnect(e),t.setConnectionStatus(ye.TERMINATED)):(null===(c=u.communicationLayer)||void 0===c||c.disconnect(e),t.setConnectionStatus(ye.DISCONNECTED))}!function(e){e.SOCKET="socket"}(Ne||(Ne={})),function(e){e.NonBrowser="nodejs",e.MetaMaskMobileWebview="in-app-browser",e.DesktopWeb="web-desktop",e.MobileWeb="web-mobile",e.ReactNative="react-native"}(Ke||(Ke={})),function(e){e.REQUEST="sdk_connect_request_started",e.REQUEST_MOBILE="sdk_connect_request_started_mobile",e.RECONNECT="sdk_reconnect_request_started",e.CONNECTED="sdk_connection_established",e.CONNECTED_MOBILE="sdk_connection_established_mobile",e.AUTHORIZED="sdk_connection_authorized",e.REJECTED="sdk_connection_rejected",e.TERMINATED="sdk_connection_terminated",e.DISCONNECTED="sdk_disconnected",e.SDK_USE_EXTENSION="sdk_use_extension",e.SDK_EXTENSION_UTILIZED="sdk_extension_utilized",e.SDK_USE_INAPP_BROWSER="sdk_use_inapp_browser"}(Oe||(Oe={}));class Fe extends i{constructor({platformType:e,communicationLayerPreference:t,otherPublicKey:n,reconnect:o,walletInfo:i,dappMetadata:r,transports:s,context:a,ecies:c,analytics:u=!1,storage:l,sdkVersion:d,communicationServerUrl:h=le,logging:g,autoConnect:f={timeout:3e3}}){super(),this.state={ready:!1,authorized:!1,isOriginator:!1,paused:!1,platformType:"metamask-mobile",analytics:!1,reconnection:!1,originatorInfoSent:!1,communicationServerUrl:le,context:"",clientsConnected:!1,sessionDuration:he,originatorConnectStarted:!1,debug:!1,_connectionStatus:ye.DISCONNECTED},this.state.otherPublicKey=n,this.state.dappMetadata=r,this.state.walletInfo=i,this.state.transports=s,this.state.platformType=e,this.state.analytics=u,this.state.isOriginator=!n,this.state.communicationServerUrl=h,this.state.context=a,this.state.sdkVersion=d,this.setMaxListeners(50),this.setConnectionStatus(ye.DISCONNECTED),(null==l?void 0:l.duration)&&(this.state.sessionDuration=he),this.state.storageOptions=l,this.state.autoConnectOptions=f,this.state.debug=!0===(null==g?void 0:g.remoteLayer),this.state.logging=g,(null==l?void 0:l.storageManager)&&(this.state.storageManager=l.storageManager),this.initCommunicationLayer({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:c,communicationServerUrl:h}),this.emitServiceStatusEvent()}initCommunicationLayer({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=le}){return function({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=le,instance:r}){var s,a,c;const{state:u}=r;if(e!==Ne.SOCKET)throw new Error("Invalid communication protocol");u.communicationLayer=new Te({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,transports:u.transports,communicationServerUrl:i,context:u.context,ecies:o,logging:u.logging});let l="undefined"!=typeof document&&document.URL||"",d="undefined"!=typeof document&&document.title||"";(null===(s=u.dappMetadata)||void 0===s?void 0:s.url)&&(l=u.dappMetadata.url),(null===(a=u.dappMetadata)||void 0===a?void 0:a.name)&&(d=u.dappMetadata.name);const h={url:l,title:d,source:null===(c=u.dappMetadata)||void 0===c?void 0:c.source,platform:u.platformType,apiVersion:ue.version};u.originatorInfo=h;const g={[me.AUTHORIZED]:De(r),[me.MESSAGE]:Be(r),[me.CLIENTS_CONNECTED]:$e(r,e),[me.KEYS_EXCHANGED]:Ue(r,e),[me.SOCKET_DISCONNECTED]:Ge(r),[me.SOCKET_RECONNECT]:je(r),[me.CLIENTS_DISCONNECTED]:Le(r,e),[me.CHANNEL_CREATED]:Pe(r),[me.CLIENTS_WAITING]:Me(r),[me.RPC_UPDATE]:()=>{r.emit(me.RPC_UPDATE)}};for(const[e,t]of Object.entries(g))try{u.communicationLayer.on(e,t)}catch(t){console.error(`Error registering handler for ${e}:`,t)}}({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i,instance:this})}originatorSessionConnect(){return c(this,void 0,void 0,(function*(){return yield function(e){var t,n,o;return c(this,void 0,void 0,(function*(){const{state:i}=e;if(!i.storageManager)return void(i.debug&&console.debug("RemoteCommunication::connect() no storage manager defined - skip"));const r=yield i.storageManager.getPersistedChannelConfig(null!==(t=i.channelId)&&void 0!==t?t:"");if(i.debug&&console.debug(`RemoteCommunication::connect() autoStarted=${i.originatorConnectStarted} channelConfig`,r),null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected())return i.debug&&console.debug("RemoteCommunication::connect() socket already connected - skip"),r;if(r){if(r.validUntil>Date.now())return i.channelConfig=r,i.originatorConnectStarted=!0,i.channelId=null==r?void 0:r.channelId,i.reconnection=!0,null===(o=i.communicationLayer)||void 0===o||o.connectToChannel({channelId:r.channelId,isOriginator:!0}),r;i.debug&&console.log("RemoteCommunication::autoConnect Session has expired")}i.originatorConnectStarted=!1}))}(this)}))}generateChannelIdConnect(){return c(this,void 0,void 0,(function*(){return function(e){var t,n,o,i,r;if(!e.communicationLayer)throw new Error("communication layer not initialized");if(e.ready)throw new Error("Channel already connected");if(e.channelId&&(null===(t=e.communicationLayer)||void 0===t?void 0:t.isConnected()))return console.warn("Channel already exists -- interrupt generateChannelId",e.channelConfig),e.channelConfig={channelId:e.channelId,validUntil:Date.now()+e.sessionDuration},null===(n=e.storageManager)||void 0===n||n.persistChannelConfig(e.channelConfig),{channelId:e.channelId,pubKey:null===(i=null===(o=e.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.ecies.public};e.debug&&console.debug("RemoteCommunication::generateChannelId()"),fe(e);const s=e.communicationLayer.createChannel();e.debug&&console.debug("RemoteCommunication::generateChannelId() channel created",s);const a={channelId:s.channelId,validUntil:Date.now()+e.sessionDuration};return e.channelId=s.channelId,e.channelConfig=a,null===(r=e.storageManager)||void 0===r||r.persistChannelConfig(a),{channelId:e.channelId,pubKey:s.pubKey}}(this.state)}))}clean(){return fe(this.state)}connectToChannel(e,t){return function({channelId:e,withKeyExchange:t,state:n}){var o,i,s;if(!r(e))throw console.debug(`RemoteCommunication::${n.context}::connectToChannel() invalid channel channelId=${e}`),new Error(`Invalid channel ${e}`);if(n.debug&&console.debug(`RemoteCommunication::${n.context}::connectToChannel() channelId=${e}`),null===(o=n.communicationLayer)||void 0===o?void 0:o.isConnected())return void console.debug(`RemoteCommunication::${n.context}::connectToChannel() already connected - interrup connection.`);n.channelId=e,null===(i=n.communicationLayer)||void 0===i||i.connectToChannel({channelId:e,withKeyExchange:t});const a={channelId:e,validUntil:Date.now()+n.sessionDuration};n.channelConfig=a,null===(s=n.storageManager)||void 0===s||s.persistChannelConfig(a)}({channelId:e,withKeyExchange:t,state:this.state})}sendMessage(e){return He(this,e)}testStorage(){return c(this,void 0,void 0,(function*(){return function(e){var t,n;return c(this,void 0,void 0,(function*(){const o=yield null===(t=e.storageManager)||void 0===t?void 0:t.getPersistedChannelConfig(null!==(n=e.channelId)&&void 0!==n?n:"");console.debug("RemoteCommunication.testStorage() res",o)}))}(this.state)}))}getChannelConfig(){return this.state.channelConfig}isReady(){return this.state.ready}isConnected(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.isConnected()}isAuthorized(){return this.state.authorized}isPaused(){return this.state.paused}getCommunicationLayer(){return this.state.communicationLayer}ping(){var e;this.state.debug&&console.debug(`RemoteCommunication::ping() channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.ping()}keyCheck(){var e;this.state.debug&&console.debug(`RemoteCommunication::keyCheck() channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.keyCheck()}setConnectionStatus(e){this.state._connectionStatus!==e&&(this.state._connectionStatus=e,this.emit(me.CONNECTION_STATUS,e),this.emitServiceStatusEvent())}emitServiceStatusEvent(){this.emit(me.SERVICE_STATUS,this.getServiceStatus())}getConnectionStatus(){return this.state._connectionStatus}getServiceStatus(){return{originatorInfo:this.state.originatorInfo,keyInfo:this.getKeyInfo(),connectionStatus:this.state._connectionStatus,channelConfig:this.state.channelConfig,channelId:this.state.channelId}}getKeyInfo(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getKeyInfo()}resetKeys(){var e;null===(e=this.state.communicationLayer)||void 0===e||e.resetKeys()}setOtherPublicKey(e){var t;const n=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange();if(!n)throw new Error("KeyExchange is not initialized.");n.getOtherPublicKey()!==e&&n.setOtherPublicKey(e)}pause(){var e;this.state.debug&&console.debug(`RemoteCommunication::pause() channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.pause(),this.setConnectionStatus(ye.PAUSED)}getVersion(){return ue.version}resume(){return function(e){var t;const{state:n}=e;n.debug&&console.debug(`RemoteCommunication::resume() channel=${n.channelId}`),null===(t=n.communicationLayer)||void 0===t||t.resume(),e.setConnectionStatus(ye.LINKED)}(this)}getChannelId(){return this.state.channelId}getRPCMethodTracker(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getRPCMethodTracker()}disconnect(e){return ze({options:e,instance:this})}}!function(e){e.RENEW="renew",e.LINK="link"}(Re||(Re={}));export{Re as AutoConnectType,Ne as CommunicationLayerPreference,ye as ConnectionStatus,le as DEFAULT_SERVER_URL,ce as ECIES,me as EventType,ve as MessageType,Ke as PlatformType,Fe as RemoteCommunication,u as SendAnalytics,Te as SocketService,Oe as TrackingEvents};
//# sourceMappingURL=metamask-sdk-communication-layer.js.map
